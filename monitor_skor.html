<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Skor Cloud - Fungi Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-indigo-700 p-6 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Data Skor Cloud</h1>
                    <p class="text-sm opacity-80">Memantau hasil latihan kuis secara real-time</p>
                </div>
                <button onclick="location.reload()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm transition">
                    Segarkan Data
                </button>
            </div>

            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-slate-50 border-b">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-xs text-slate-500 uppercase font-bold">Total Peserta</p>
                    <p id="total-players" class="text-2xl font-black text-indigo-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-xs text-slate-500 uppercase font-bold">Rata-rata Skor</p>
                    <p id="avg-score" class="text-2xl font-black text-emerald-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-xs text-slate-500 uppercase font-bold">Status Database</p>
                    <p id="db-status" class="text-sm font-bold text-orange-500">Menghubungkan...</p>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-600 text-sm uppercase">
                            <th class="p-4 border-b">ID Pengguna (UID)</th>
                            <th class="p-4 border-b">Skor</th>
                            <th class="p-4 border-b">Benar</th>
                            <th class="p-4 border-b">Waktu Selesai</th>
                        </tr>
                    </thead>
                    <tbody id="score-table-body" class="text-slate-700">
                        <!-- Data akan muncul di sini -->
                        <tr>
                            <td colspan="4" class="p-10 text-center text-slate-400 italic">
                                Sedang mengambil data dari cloud...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <p class="text-center text-slate-500 text-xs mt-6">
            Data ini diambil langsung dari koleksi Cloud Firestore <br>
            Path: /artifacts/${appId}/users/{userId}/quiz_scores/
        </p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fungi-quiz-app';

        const tableBody = document.getElementById('score-table-body');
        const dbStatus = document.getElementById('db-status');

        // 1. Login Dulu (Wajib sebelum akses data)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                dbStatus.innerText = "Gagal Login";
                console.error(err);
            }
        };

        // 2. Pantau Data secara Real-Time
        onAuthStateChanged(auth, (user) => {
            if (user) {
                dbStatus.innerText = "Terhubung (Live)";
                dbStatus.classList.replace('text-orange-500', 'text-emerald-500');
                
                // Mengambil data publik dari semua user (Note: Menggunakan struktur path Rule 1)
                // Karena kita ingin melihat "siapa saja", kita akses koleksi data publik
                const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'all_scores');
                
                onSnapshot(scoresRef, (snapshot) => {
                    renderTable(snapshot);
                }, (error) => {
                    console.error("Error fetching scores:", error);
                    tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-red-500 text-center">Error: ${error.message}. Pastikan kuis sudah pernah diselesaikan sekali.</td></tr>`;
                });
            }
        });

        function renderTable(snapshot) {
            if (snapshot.empty) {
                tableBody.innerHTML = `<tr><td colspan="4" class="p-10 text-center text-slate-400">Belum ada data skor tersimpan.</td></tr>`;
                return;
            }

            let html = '';
            let total = 0;
            let count = 0;

            snapshot.forEach((doc) => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp).toLocaleString('id-ID') : '-';
                
                total += data.score || 0;
                count++;

                html += `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                        <td class="p-4 font-mono text-xs text-indigo-600">${doc.id}</td>
                        <td class="p-4 font-bold">${data.score}%</td>
                        <td class="p-4">${data.correctAnswers} / ${data.totalQuestions}</td>
                        <td class="p-4 text-sm text-slate-500">${date}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            document.getElementById('total-players').innerText = count;
            document.getElementById('avg-score').innerText = count > 0 ? Math.round(total / count) + '%' : '0%';
        }

        initAuth();
    </script>
</body>
</html>
